using System;
using System.Collections.Generic;
using System.Linq;
using Autodesk.Revit.Attributes;
using Autodesk.Revit.DB;
using Autodesk.Revit.UI;
using Autodesk.Revit.UI.Selection;

namespace RevitRotateAddin
{
    /// <summary>
    /// Filter to select elements that can be used as rotation axis (has curve type Line)
    /// </summary>
    public class AxisSelectionFilter : ISelectionFilter
    {
        public bool AllowElement(Element elem)
        {
            // Check if element has Location.Curve that is a Line
            if (elem?.Location is LocationCurve locationCurve && 
                locationCurve.Curve is Line)
            {
                return true;
            }
            return false;
        }

        public bool AllowReference(Reference reference, XYZ position)
        {
            return false;
        }
    }

    /// <summary>
    /// Command to rotate selected objects around an axis
    /// </summary>
    [Transaction(TransactionMode.Manual)]
    [Regeneration(RegenerationOption.Manual)]
    public class RotateElementsCommand : IExternalCommand
    {
        public Result Execute(ExternalCommandData commandData, ref string message, ElementSet elements)
        {
            UIApplication uiApp = commandData.Application;
            UIDocument uiDoc = uiApp.ActiveUIDocument;
            Document doc = uiDoc.Document;

            try
            {
                // 1. Check selected elements
                ICollection<ElementId> selectedIds = uiDoc.Selection.GetElementIds();
                if (selectedIds.Count == 0)
                {
                    TaskDialog.Show("Notification", "Please select at least one object to rotate.");
                    return Result.Cancelled;
                }

                // 2. Get rotation angle
                double rotationAngle = GetRotationAngleFromUser();
                if (double.IsNaN(rotationAngle))
                {
                    return Result.Cancelled;
                }

                // 3. Select rotation axis
                Line rotationAxis = SelectRotationAxis(uiDoc);
                if (rotationAxis == null)
                {
                    return Result.Cancelled;
                }

                // 4. Checkout elements if workshared
                if (doc.IsWorkshared)
                {
                    try
                    {
                        WorksharingUtils.CheckoutElements(doc, selectedIds);
                    }
                    catch (Exception ex)
                    {
                        TaskDialog.Show("Checkout Error", $"Cannot checkout elements: {ex.Message}");
                        return Result.Failed;
                    }
                }

                // 5. Perform rotation
                using (Transaction trans = new Transaction(doc, "Rotate objects around axis"))
                {
                    trans.Start();
                    ElementTransformUtils.RotateElements(doc, selectedIds, rotationAxis, rotationAngle);
                    trans.Commit();
                }

                // 6. Ask user if direction is correct
                TaskDialogResult result = TaskDialog.Show(
                    "Confirmation", 
                    "Objects have been rotated. Is the direction correct?",
                    TaskDialogCommonButtons.Yes | TaskDialogCommonButtons.No);

                if (result == TaskDialogResult.No)
                {
                    // Rotate back by rotating additional -2 * original angle
                    using (Transaction trans = new Transaction(doc, "Rotate reverse direction"))
                    {
                        trans.Start();
                        ElementTransformUtils.RotateElements(doc, selectedIds, rotationAxis, -2 * rotationAngle);
                        trans.Commit();
                    }
                }

                return Result.Succeeded;
            }
            catch (Autodesk.Revit.Exceptions.OperationCanceledException)
            {
                return Result.Cancelled;
            }
            catch (Exception ex)
            {
                message = $"Error: {ex.Message}";
                return Result.Failed;
            }
        }

        /// <summary>
        /// Get rotation angle from user
        /// </summary>
        private double GetRotationAngleFromUser()
        {
            using (var form = new AngleInputForm())
            {
                if (form.ShowDialog() == System.Windows.Forms.DialogResult.OK)
                {
                    // Convert from degrees to radians
                    return form.AngleInDegrees * Math.PI / 180.0;
                }
            }
            return double.NaN;
        }

        /// <summary>
        /// Allow user to select rotation axis
        /// </summary>
        private Line SelectRotationAxis(UIDocument uiDoc)
        {
            try
            {
                Reference reference = uiDoc.Selection.PickObject(
                    ObjectType.Element, 
                    new AxisSelectionFilter(), 
                    "Select a line as rotation axis");

                Element axisElement = uiDoc.Document.GetElement(reference);
                if (axisElement?.Location is LocationCurve locationCurve && 
                    locationCurve.Curve is Line line)
                {
                    return line;
                }
            }
            catch (Autodesk.Revit.Exceptions.OperationCanceledException)
            {
                // User cancelled
            }
            
            return null;
        }
    }
}